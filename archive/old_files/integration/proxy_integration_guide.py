#!/usr/bin/env python3
"""
üî• COMPLETE PROXY INTEGRATION GUIDE
Shows exactly where to add proxy initialization and how to start automatically
"""

import os
import sys
import subprocess
import time


def show_integration_options():
    """Show different ways to integrate the proxy"""
    print("üî• PROXY INTEGRATION OPTIONS")
    print("=" * 60)

    print("\nüìç OPTION 1: Main OpenCode Entry Point")
    print("-" * 40)
    print("Add these 2 lines at the very beginning of your main opencode file:")
    print()
    print("# Add at TOP of your main opencode file")
    print("from opencode_proxy_plugins import initialize_proxy_plugins")
    print("initialize_proxy_plugins()  # This enables the proxy")
    print()
    print("# Example: /Users/djesys/opencode/main.py")
    print("```python")
    print("from opencode_proxy_plugins import initialize_proxy_plugins")
    print("initialize_proxy_plugins()")
    print()
    print("def main():")
    print("    # Your existing opencode code...")
    print("    print('Starting opencode with proxy...')")
    print("```")

    print("\nüìç OPTION 2: Config/Startup Module")
    print("-" * 40)
    print("Create a startup module for your opencode:")
    print()
    print("# Example: /Users/djesys/opencode/startup.py")
    print("```python")
    print("# startup.py")
    print("def initialize_all_services():")
    print("    # Initialize proxy")
    print("    from opencode_proxy_plugins import initialize_proxy_plugins")
    print("    proxy_active = initialize_proxy_plugins()")
    print("    print(f'Proxy active: {proxy_active}')")
    print("    ")
    print("    # Initialize other services...")
    print("    return proxy_active")
    print()
    print("if __name__ == '__main__':")
    print("    initialize_all_services()")
    print("```")

    print("\nüìç OPTION 3: Environment Variable (Auto-start)")
    print("-" * 40)
    print("Add to your shell profile (~/.zshrc, ~/.bashrc):")
    print()
    print("```bash")
    print("# Add to ~/.zshrc or ~/.bashrc")
    print("export OPENCODE_PROXY_ENABLED=1")
    print("export OPENCODE_PROXY_PATH=/Users/djesys/#VIBECODE")
    print()
    print("# Function to auto-start proxy")
    print("start_opencode_proxy() {")
    print("    cd /Users/djesys/#VIBECODE/webfetch-prxy")
    print("    python3 webfetch_proxy.py > /dev/null 2>&1 &")
    print("    echo 'Proxy started in background'")
    print("}")
    print()
    print("# Auto-start proxy when shell loads")
    print('if [ "$OPENCODE_PROXY_ENABLED" = "1" ]; then')
    print("    start_opencode_proxy")
    print("fi")
    print("```")


def show_proxy_auto_start():
    """Show how to start proxy automatically"""
    print("\n" + "=" * 60)
    print("üöÄ AUTOMATIC PROXY STARTUP")
    print("=" * 60)

    print("\nüü¢ METHOD 1: Background Service (Recommended)")
    print("-" * 40)
    print("Start proxy as background service:")
    print()
    print("```bash")
    print("# Start proxy in background")
    print("cd /Users/djesys/#VIBECODE/webfetch-prxy")
    print("nohup python3 webfetch_proxy.py > proxy.log 2>&1 &")
    print()
    print("# Or use the startup script")
    print("cd /Users/djesys/#VIBECODE/webfetch-prxy")
    print("./start_proxy.sh")
    print()
    print("# Check if it's running")
    print("ps aux | grep webfetch_proxy")
    print("curl http://localhost:8081/health")
    print("```")

    print("\nüü¢ METHOD 2: Launch Agent (macOS)")
    print("-" * 40)
    print("Create a launch agent for automatic startup:")
    print()
    print("```bash")
    print("# Create launch agent")
    print("cat > ~/Library/LaunchAgents/com.shadow.opencode-proxy.plist << 'EOF'")
    print('<?xml version="1.0" encoding="UTF-8"?>')
    print(
        '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">'
    )
    print('<plist version="1.0">')
    print("<dict>")
    print("    <key>Label</key>")
    print("    <string>com.shadow.opencode-proxy</string>")
    print("    <key>ProgramArguments</key>")
    print("    <array>")
    print("        <string>/opt/homebrew/bin/python3</string>")
    print(
        "        <string>/Users/djesys/#VIBECODE/webfetch-prxy/webfetch_proxy.py</string>"
    )
    print("    </array>")
    print("    <key>RunAtLoad</key>")
    print("    <true/>")
    print("    <key>KeepAlive</key>")
    print("    <true/>")
    print("    <key>WorkingDirectory</key>")
    print("    <string>/Users/djesys/#VIBECODE/webfetch-prxy</string>")
    print("</dict>")
    print("</plist>")
    print("EOF")
    print()
    print("# Load the agent")
    print("launchctl load ~/Library/LaunchAgents/com.shadow.opencode-proxy.plist")
    print()
    print("# Start immediately")
    print("launchctl start com.shadow.opencode-proxy")
    print()
    print("# Check status")
    print("launchctl list | grep opencode-proxy")
    print("```")

    print("\nüü¢ METHOD 3: Supervisor/Cron (Cross-platform)")
    print("-" * 40)
    print("Use supervisor or cron for automatic restart:")
    print()
    print("```bash")
    print("# Supervisor configuration (/etc/supervisor/conf.d/opencode-proxy.conf)")
    print("[program:opencode-proxy]")
    print("command=python3 /Users/djesys/#VIBECODE/webfetch-prxy/webfetch_proxy.py")
    print("directory=/Users/djesys/#VIBECODE/webfetch-prxy")
    print("user=djesys")
    print("autostart=true")
    print("autorestart=true")
    print("redirect_stderr=true")
    print("stdout_logfile=/var/log/opencode-proxy.log")
    print()
    print("# Or use cron to start on reboot")
    print("# Add to crontab: @reboot /path/to/start-proxy.sh")
    print("```")


def show_complete_integration():
    """Show complete integration example"""
    print("\n" + "=" * 60)
    print("üíª COMPLETE INTEGRATION EXAMPLE")
    print("=" * 60)

    print("\nüìÅ File: /Users/djesys/opencode/main.py")
    print("-" * 40)
    print("```python")
    print("#!/usr/bin/env python3")
    print('"""')
    print("Main OpenCode Application")
    print('"""')
    print()
    print("# üî• STEP 1: Initialize proxy at startup")
    print("from opencode_proxy_plugins import initialize_proxy_plugins")
    print("proxy_status = initialize_proxy_plugins()")
    print()
    print("if proxy_status:")
    print("    print(f'‚úÖ Proxy active: {proxy_status}')")
    print("else:")
    print("    print('‚ö†Ô∏è Proxy not active - using direct requests')")
    print()
    print("# Regular imports")
    print("import requests")
    print("import json")
    print()
    print("class OpenCodeLLM:")
    print("    def __init__(self):")
    print("        self.proxy_active = bool(proxy_status)")
    print("        print(f'OpenCode LLM initialized (proxy: {self.proxy_active})')")
    print("    ")
    print("    def web_search(self, query):")
    print('        """Enhanced web search with proxy"""')
    print("        # This will automatically use proxy if available")
    print("        response = requests.get(f'https://api.github.com/search?q={query}')")
    print("        return response.json()")
    print("    ")
    print("    def get_documentation(self, topic):")
    print('        """Get documentation with proxy"""')
    print("        # Automatically routed through proxy if needed")
    print(
        "        response = requests.get(f'https://docs.python.org/3/library/{topic}.html')"
    )
    print("        return response.text")
    print()
    print("def main():")
    print('    """Main application entry point"""')
    print("    print('üöÄ Starting OpenCode LLM...')")
    print("    ")
    print("    # Initialize LLM")
    print("    llm = OpenCodeLLM()")
    print("    ")
    print("    # Example usage")
    print("    print('üîç Testing web search...')")
    print("    results = llm.web_search('python asyncio')")
    print("    print(f'Found {len(results.get(\"items\", []))} results')")
    print("    ")
    print("    print('üìö Getting documentation...')")
    print("    doc = llm.get_documentation('asyncio')")
    print("    print(f'Documentation length: {len(doc)} chars')")
    print("    ")
    print("    print('‚úÖ OpenCode LLM with proxy complete!')")
    print()
    print("if __name__ == '__main__':")
    print("    main()")
    print("```")

    print("\nüìÅ File: /Users/djesys/opencode/start_proxy.py")
    print("-" * 40)
    print("```python")
    print("#!/usr/bin/env python3")
    print('"""')
    print("Auto-start proxy for OpenCode")
    print('"""')
    print()
    print("import subprocess")
    print("import os")
    print("import sys")
    print("import time")
    print("import requests")
    print()
    print("def start_proxy_if_needed():")
    print('    """Start proxy if not already running"""')
    print("    try:")
    print("        # Check if proxy is already running")
    print("        response = requests.get('http://localhost:8081/health', timeout=2)")
    print("        if response.status_code == 200:")
    print("            print('‚úÖ Proxy already running')")
    print("            return True")
    print("    except:")
    print("        pass")
    print("    ")
    print("    # Start proxy")
    print("    print('üöÄ Starting proxy...')")
    print(
        "    proxy_script = '/Users/djesys/#VIBECODE/webfetch-prxy/webfetch_proxy.py'"
    )
    print("    log_file = '/Users/djesys/#VIBECODE/logs/proxy.log'")
    print("    ")
    print("    try:")
    print("        # Start in background")
    print("        subprocess.Popen([")
    print("            'python3', proxy_script")
    print("        ], stdout=open(log_file, 'w'), stderr=subprocess.STDOUT)")
    print("        ")
    print("        # Wait for startup")
    print("        for i in range(10):")
    print("            try:")
    print("                time.sleep(1)")
    print(
        "                response = requests.get('http://localhost:8081/health', timeout=2)"
    )
    print("                if response.status_code == 200:")
    print("                    print('‚úÖ Proxy started successfully')")
    print("                    return True")
    print("            except:")
    print("                continue")
    print("        ")
    print("        print('‚ùå Proxy failed to start')")
    print("        return False")
    print("    except Exception as e:")
    print("        print(f'‚ùå Error starting proxy: {e}')")
    print("        return False")
    print()
    print("if __name__ == '__main__':")
    print("    success = start_proxy_if_needed()")
    print("    sys.exit(0 if success else 1)")
    print("```")


def show_startup_checks():
    """Show how to check startup status"""
    print("\n" + "=" * 60)
    print("üîç STARTUP VERIFICATION")
    print("=" * 60)

    print("\n‚úÖ Test Proxy Status")
    print("-" * 40)
    print("```python")
    print("# Add to your opencode to verify proxy")
    print("def check_proxy_status():")
    print("    try:")
    print("        response = requests.get('http://localhost:8081/health', timeout=2)")
    print("        if response.status_code == 200:")
    print("            print('‚úÖ Proxy is running')")
    print("            return True")
    print("    except:")
    print("        pass")
    print("    print('‚ùå Proxy not available')")
    print("    return False")
    print()
    print("# Use in your main()")
    print("def main():")
    print("    if check_proxy_status():")
    print("        from opencode_proxy_plugins import initialize_proxy_plugins")
    print("        initialize_proxy_plugins()")
    print("        print('‚úÖ Proxy integration active')")
    print("    else:")
    print("        print('‚ö†Ô∏è Using direct requests')")
    print("```")

    print("\n‚úÖ Complete Startup Script")
    print("-" * 40)
    print("```bash")
    print("#!/bin/bash")
    print("# startup.sh - Complete startup script")
    print()
    print("echo 'üöÄ Starting OpenCode with Proxy...'")
    print()
    print("# Step 1: Start proxy if needed")
    print("echo 'üîß Checking proxy...'")
    print("if ! curl -s http://localhost:8081/health > /dev/null; then")
    print("    echo 'üì° Starting proxy...'")
    print("    cd /Users/djesys/#VIBECODE/webfetch-prxy")
    print("    python3 webfetch_proxy.py > /dev/null 2>&1 &")
    print("    sleep 3")
    print("fi")
    print()
    print("# Step 2: Test proxy")
    print("if curl -s http://localhost:8081/health > /dev/null; then")
    print("    echo '‚úÖ Proxy active'")
    print("else")
    print("    echo '‚ùå Proxy failed to start'")
    print("    exit 1")
    print("fi")
    print()
    print("# Step 3: Start opencode")
    print("echo 'ü§ñ Starting OpenCode LLM...'")
    print("cd /Users/djesys/opencode")
    print("python3 main.py")
    print("```")


def main():
    """Main function"""
    print("üî• COMPLETE PROXY INTEGRATION GUIDE")
    print("=" * 70)
    print("Exactly where and how to add proxy initialization")

    show_integration_options()
    show_proxy_auto_start()
    show_complete_integration()
    show_startup_checks()

    print("\n" + "=" * 70)
    print("üéØ QUICK START SUMMARY")
    print("=" * 70)
    print("\n1Ô∏è‚É£  START PROXY AUTOMATICALLY:")
    print("   cd /Users/djesys/#VIBECODE/webfetch-prxy")
    print("   ./start_proxy.sh")
    print()
    print("2Ô∏è‚É£  ADD TO OPENCODE MAIN:")
    print("   # At top of your main opencode file:")
    print("   from opencode_proxy_plugins import initialize_proxy_plugins")
    print("   initialize_proxy_plugins()")
    print()
    print("3Ô∏è‚É£  VERIFY IT WORKS:")
    print("   # Add to your code:")
    print("   import requests")
    print("   response = requests.get('https://api.github.com')")
    print("   print(f'Status: {response.status_code}')")
    print()
    print("üöÄ That's it! Your opencode LLM now uses the proxy automatically!")


if __name__ == "__main__":
    main()
